<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Live Bus Tracking</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            text-align: center;
        }
        #map {
            height: 400px;
            width: 100%;
            margin-top: 10px;
        }
        .info {
            margin: 10px;
            font-size: 18px;
        }
    </style>
</head>
<body>
    <h1>Live Bus Tracking</h1>
    <p>Tracking Bus No: <strong id="bus_no"></strong></p>
    <div class="info">Current Location: <span id="location">Loading...</span></div>
    <div class="info">Latitude: <span id="lat">0</span>, Longitude: <span id="lng">0</span></div>
    <div id="map"></div>

    <script>
        const busNo = window.location.pathname.split("/").pop();
        document.getElementById("bus_no").innerText = busNo;

        const map = L.map('map').setView([0, 0], 15);
        L.tileLayer('https://mt1.google.com/vt/lyrs=m&x={x}&y={y}&z={z}', {
            attribution: '&copy; Chandusmarttechtuts'
        }).addTo(map);

        const busIcon = L.icon({
            iconUrl: "/static/images/bus.png", // Ensure this path is correct
            iconSize: [30, 30],
            iconAnchor: [15, 15]
        });

        let polyline = L.polyline([], { color: 'blue' }).addTo(map);
        let marker = null;

        async function updateMap() {
            try {
                const response = await fetch(`/get_locations/${busNo}`);
                const locations = await response.json();

                console.log("Fetched locations:", locations);

                if (locations.length === 0) {
                    console.warn("No valid location data available");
                    return;
                }

                const lastLocation = locations[locations.length - 1];

                if (!lastLocation.latitude || !lastLocation.longitude) {
                    console.warn("Invalid location data:", lastLocation);
                    return;
                }

                const lastLatLng = [lastLocation.latitude, lastLocation.longitude];

                if (marker) {
                    marker.setLatLng(lastLatLng);
                } else {
                    marker = L.marker(lastLatLng, { icon: busIcon }).addTo(map);
                }

                polyline.setLatLngs(locations.map(loc => [loc.latitude, loc.longitude]));

                map.setView(lastLatLng, 18, { animate: true });

                document.getElementById('location').innerText = lastLocation.area || "Unknown";
                document.getElementById('lat').innerText = lastLocation.latitude;
                document.getElementById('lng').innerText = lastLocation.longitude;
            } catch (error) {
                console.error("Error fetching bus data:", error);
            }
        }

        setInterval(updateMap, 3000);
    </script>
</body>
</html>
